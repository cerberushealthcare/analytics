/**
 * ReportStubView
 *   TableLoader table
 */
ReportStubView = {
  create:function(container) {
    var My = this;
    return Html.Tile.create(container, 'ReportStubView').extend(function(self) {
      return {
        onselect:function(stub) {},
        oncreate:function(report) {},
        //
        init:function() {
          self.table = My.Table.create(self).bubble('onselect', self);
          self.cb = Html.CmdBar.create(self).add('New Report...', self.add_onclick);
          self._pad = self.cb.height();
          if (me.userType == 3)
            self.cb.hide();
          self.load();
        },
        load:function() {
          self.table.load();
        },
        setMaxHeight:function(i) {
          self.table.setMaxHeight(i - self._pad);
        },
        //
        add_onclick:function() {
          NewReportTypePop.pop(function(type) {
            ReportCriteria.ajax(self).asNew(type, self.oncreate);
          })
        }
      }
    })
  },
  Table:{
    create:function(container) {
      return Html.TableLoader.create(container, 'fsy vtop').extend(function(self) {
        return {
          onselect:function(report) {},
          //
          init:function() {
            self.thead().trFixed().th('Name').w('25%').th('Description').w('75%');
            self.addTopFilter().hideAllLabel().onset(self.filter_onset);
            if (container.filtering == null)
              container.filtering = ReportCriteria.TYPES[ReportCriteria.TYPE_PATIENT];
          },
          //
          rowKey:function(rec) {
            return rec.reportId; 
          },
          filter:function(rec) {
            return {'Type':rec._type || container.filtering};
          },
          filter_onset:function(filter) {
            container.filtering = filter.Type;
          },
          fetch:function(callback_recs) {
            ReportStubs.ajax().getAll(callback_recs);
          },
          add:function(report, tr) {
            var cls = report.isAppLevel() ? 'AppReport' : 'Report';
            tr.select(Html.AnchorAction.create(cls, report.name)).td(report.uiComment(), 'comment');
          },
          setMaxHeight:function(i) {
            self.setHeight(i);
          }
        }
      })
    }
  }
}
/**
 * ReportView
 *   Header header
 *   ReportTablePanels Panels
 */
ReportView = {
  create:function(container) {
    var My = this;
    return Html.Tile.create(container, 'ReportView').extend(function(self) {
      return {
        onedit:function(report) {},
        onexit:function() {},
        //
        init:function() {
          self.info = Html.Tile.create(self, 'cj');
          self.info.style.paddingBottom = '10px';
          self.header = My.Header.create(self).bubble('onedit', self).bubble('onexit', self);
          self.panels = ReportTablePanels.create(self);
        },
        loadFromStub:function(stub) {
          if (stub.type == 1) {
            var h = '<h3>' + me.name + ' - ' + me.userGroup.name + ' - ' + me.userGroup.address.addrLine + ' ' + me.userGroup.address.csz + '</h3>';
            self.info.show().html(h);
          } else {
            self.info.hide();
          }
          self.reset();
          ReportCriteria.ajax(self).get(stub.reportId, self.load);
        },
        setMaxHeight:function(i) {
          i = (i) ? self._padContainer = i : self._padContainer;
          self._pad = self.header.getHeight();
          self.panels.setMaxHeight(i - self._pad);
        },
        reset:function() {
          self.panels.reset();
          self.header.reset();
        },
        /*
         * @arg ReportCriteria report
         */
        load:function(report) {
          self.reset();
          self.report = report;
          self.header.load(report);
          self.panels.load(report);
          self.setMaxHeight();
        }
      }
    })
  },
  Header:{
    create:function(container) {
      return Html.Tile.create(container, 'ReportViewHeader').extend(function(self) {
        return {
          onedit:function(report) {},
          onexit:function() {},
          //
          init:function() {
            var t = Html.Table2ColHead.create(self);
            self.h2 = Html.H2.create('Report').nbsp().into(t.left);
            self.custom = Html.AnchorAction.asCustom('Configure this report').into(t.right).bubble('onclick', self.custom_onclick);
            self.exit = Html.AnchorAction.create('back', 'Return to list').into(t.right).bubble('onclick', self, 'onexit');
            self.comment = Html.Div.create('Comment').setText('Description').into(self);
            self.summary = Html.SplitTile.create(self);
            if (me.userType == 3)
              self.custom.invisible();
          },
          reset:function() {
            self.invisible();
          },
          load:function(report) {
            self.report = report;
            self.h2.setText(report.name);
            self.comment.setText(report.uiComment());
            self.summary.left.html(report.summary('<br>&bull; '));
            if (report.isFractioned()) { 
              self.summary.right.html(report.summary('<br>&bull; ', report.RecDenom));
              self.summary.showBoth();
            } else {
              self.summary.showLeft();
            }
            self.custom.showIf(report.isEditable()); 
            self.visible();
          },
          //
          custom_onclick:function() {
            self.onedit(self.report);
          }
        }
      })
    }
  }
}
/**
 * ReportCriteriaView
 *   ReportAnchor reportAnchor
 *   SplitAnchor splitAnchor 
 *   TreeSplitTile tree
 *     ReportTree tree (left)
 *     Tiles tiles (right)
 *       ReportTree treeDenom
 *       IpcHmEntry entryIpcHm
 *   ReportTablePanels panels
 */
ReportCriteriaView = {
  create:function(container) {
    var My = this;
    return Html.Tile.create(container, 'ReportCriteriaView').extend(function(self) {
      return {
        onexit:function() {},
        //
        init:function() {
          self.split = Html.SplitTile.create(self);
          self.reportAnchor = My.ReportAnchor.create().into(self.split.left).bubble('onsave', self.report_onsave).bubble('ondelete', self.close.curry(true));
          self.splitAnchor = My.SplitAnchor.create().into(self.split.right).bubble('onupdate', self.split_onupdate);
          self.tree = My.TreeSplitTile.create(Html.Tile.create(self, 'TreeTile')).bubble('onresize', self.tree_resize).bubble('onupdate', self.tree_onupdate).bubble('ondelete', self.close.curry(true)).bubble('onsave', self.onsave);
          self.cb = Html.CmdBar.create(self).button('Generate Report', self.generate_onclick, 'report').lbl('').save(self.save_onclick).del(self.del_onclick, 'Delete Report').exit(self.close).container();
          self.tile = Html.Tile.create(self, 'mt10');
          self.panels = ReportTablePanels.create(self.tile).hide();
        },
        /*
         * @arg ReportCriteria report
         */
        load:function(report) {
          self.setDirty(false);
          self.panels.hide();
          if (report == null)
            ReportCriteria.ajax(self).asNew(self.setReport);
          else
            self.setReport(report);
        },
        setReport:function(report) {
          self.report = report;
          self.reportAnchor.load(report);
          self.splitAnchor.load(report);
          self.tree.load(report);
        },
        //
        save:function(callback) {
          self.report.ajax(self).save(function(report) {
            self.load(report);
            callback();
          })
        },
        close:function(saved) {
          if (saved || ! self.dirty)
            self.onexit();
          else
            Pop.Confirm.showDirtyExit(self.saveAndExit, self.onexit);
        },
        generate_onclick:function() {
          self.panels.show().load(self.report);
        },
        save_onclick:function() {
          self.working(function() {
            self.save(self.onsave);
          })
        },
        onsave:function() {
          Html.Animator.fade(self.tree);
        },
        del_onclick:function() {
          Pop.Confirm.showDelete('report', function() {
            ReportCriteria.ajax(self).remove(self.report.reportId, self.close.curry(true));
          })
        },
        setDirty:function(value) {
          self.dirty = value;
          self.reportAnchor.setDirty(value);
        },
        tree_onupdate:function() {
          self.setDirty(true);
        },
        split_onupdate:function() {
          self.tree.load(self.report);
          self.setDirty(true);
        },
        saveAndExit:function() {
          self.save(self.close);
        },
        exit_onclick:function() {
          self.onexit();
        },
        resize:function(pad) {
        },
        tree_resize:function(expanded) {
          Html.Window.flickerFixedRows();
        },
        report_onsave:function(report) {
          self.setReport(report);
          self.onsave();
        }
      }
    })
  },
  SplitAnchor:{
    create:function() {
      var My = this;
      return Html.Span.create().extend(function(self) {
        return {
          onupdate:function() {},
          //
          init:function() {
            Html.Tiles.create(self, [
              self.empty = Html.Tile.create(self),
              self.denomAnchor = My.DenomAnchor.create(self).into(self).bubble('onupdate', self),
              self.cdsAnchor = My.CdsAnchor.create(self).into(self).bubble('onupdate', self)]);
          },
          load:function(report) {
            if (report.isFractionable())
              self.denomAnchor.select().load(report);
            else if (report.isTypeCds())
              self.cdsAnchor.select().load(report);
            else
              self.empty.select();
          }
        }
      })
    },
    CdsAnchor:{
      create:function() {
        return Html.Span.create().extend(function(self) {
          return {
            onupdate:function() {},
            //
            init:function() {
              self.add = Html.AnchorAction.create('AddIpc', 'Attach Ipc...').into(self).bubble('onclick', self.add_onclick);
              self.remove = Html.AnchorAction.create('Ipc', 'Ipc').into(self).bubble('onclick', self.remove_onclick);
            },
            load:function(report) {
              self.report = report;
              self.draw();
            },
            draw:function() {
              if (self.report.hasIpcHm()) {
                self.add.hide();
                self.remove.setText(self.report.IpcHm.Ipc.name).show();
              } else {
                self.add.show();
                self.remove.hide();
              }
            },
            //
            add_onclick:function() {
              IpcPickerPop.pop().bubble('onselect', function(rec) {
                self.report.addIpcHm(rec);
                self.draw();
                self.onupdate();
              })
            },
            remove_onclick:function() {
              Pop.Confirm.showYesNo('Are you sure you want to detach this IPC?', function() {
                self.report.removeIpcHm();
                self.draw();
                self.onupdate();
              })
            }
          }
        })
      }
    },
    DenomAnchor:{
      create:function() {
        return Html.Span.create().extend(function(self) {
          return {
            onupdate:function() {},
            //
            init:function() {
              self.add = Html.AnchorAction.create('AddDenom', 'Add Denominator...').into(self).bubble('onclick', self.add_onclick);
              self.remove = Html.AnchorAction.create('Denom', 'Denominator').into(self).bubble('onclick', self.remove_onclick);
            },
            load:function(report) {
              self.report = report;
              self.draw();
            },
            draw:function() {
              if (self.report.isFractioned()) {
                self.add.hide();
                self.remove.show();
              } else {
                self.add.show();
                self.remove.hide();
              }
            },
            //
            add_onclick:function() {
              self.report.addDenom();
              self.draw();
              self.onupdate();
            },
            remove_onclick:function() {
              Pop.Confirm.showDelete('denominator', function() {
                self.report.removeDenom();
                self.draw();
                self.onupdate();
              })
            }
          }
        })
      }
    }
  },
  ReportAnchor:{
    /*
     * @arg ReportCriteria report
     */
    create:function() {
      return Html.Span.create().extend(function(self) {
        return {
          onpop:function() {},
          onsave:function(report) {},
          ondelete:function() {},
          //
          init:function() {
            self.reportAnchor = Html.AnchorAction.create('Report').into(self).bubble('onclick', self.pop);
            //self.commentAnchor = Html.Anchor.create('ml5').into(self).bubble('onclick', self.pop.curry('comment'));
          },
          load:function(report) {
            self.report = report;
            self.reportAnchor.setText(report.name);
            //self.commentAnchor.setText(report.comment || '(No Description)');
          },
          pop:function(focusId) {
            self.onpop();
            return ReportEntryPop.pop(self.report, focusId).bubble('onsave', self).bubble('ondelete', self);
          },
          setDirty:function(value) {
            self.reportAnchor.addClassIf('dirty', value);
            self.reportAnchor.tooltip(value ? 'Report has unsaved changes' : null);
          }
        }
      })
    }
  },
  TreeSplitTile:{
    create:function(container) {
      return Html.SplitTile.create(container).extend(function(self) {
        return {
          onresize:function() {},
          onupdate:function() {},
          onsave:function() {},
          //
          init:function() {
            self.tree = ReportTree.create(self.left).bubble('onresize', self).bubble('onupdate', self);
            self.tiles = Html.Tiles.create(self.right, [
              self.treeDenom = ReportTree.create(self.right).bubble('onresize', self).bubble('onupdate', self).bubble('onsave', self),
              self.entryIpcHm = IpcHmEntry.create(self.right).bubble('onupdate', self)]);
         },
          load:function(report) {
            self.tree.load(report, report.Rec);
            if (report.isFractioned()) {
              self.treeDenom.select().load(report, report.RecDenom);
              self.showBoth();
            } else if (report.hasIpcHm()) {
              self.entryIpcHm.select().load(report);
              self.showBoth();
            } else { 
              self.showLeft();
            }
          }
        }
      })
    }
  }
}
/**
 * UlEntry IpcHmEntry
 */
IpcHmEntry = {
  create:function(container) {
    return Html.UlEntry.create(container).addClass('ml20 mt5').extend(function(self) {
      var ef = self.ef;
      return {
        onupdate:function() {},
        //
        init:function() {
          ef.line().check('auto', 'Interval', self.auto_onclick).startSpan('freq').lbl('every', 'nopad').textbox('every', 2).lbl('', 'spacer').select('interval', C_IpcHm.INTERVALS).endSpan();
        },
        onload:function(report) {
          self.report = report;
          var rec = report.IpcHm;
          rec.auto = rec.every > 0;
          rec.every = rec.every || 1;
          rec.interval = rec.interval || C_IpcHm.INT_YEAR;
          return rec;
        },
        onchange:function() {
          self.applyTo();
          self.onupdate();
          self.ef.resetRecordChanged();
        },
        applyTo:self.applyTo.append(function(rec) {
          rec.every = (rec.auto) ? rec.every : 0;
        }),
        draw:function() {
          ef.freq.visibleIf(self.rec.auto);
        },
        auto_onclick:function() {
          self.rec.auto = ef.getValue('auto');
          self.draw();
        }
      }
    })
  }
}
/**
 * Ul ReportTree
 *   Rec
 *   JoinAnchor[]
 *     Rec[]
 *     AnotherJoinRecAnchor
 *   NewJoinAnchor   
 */
ReportTree = {
  create:function(container) {
    var My = this;
    return Html.Ul.create('ReportTree').into(container).extend(function(self) {
      return {
        onresize:function() {},
        onupdate:function() {},
        //
        /*
         * @arg ReportCriteria report
         * @arg Rec rec (e.g. report.Rec or report.RecDenom)
         */
        load:function(report, rec) {
          self.report = report;
          self.rec = rec || report.Rec;
          self.draw();
        },
        draw:function() {
          self.clean();
          self.items = [];
          self.add(1, My.Rec.create(self.rec).bubble('onupdate', self.update));
          Array.forEach(self.rec.Joins, function(join) {
            self.add(1, My.JoinAnchor.create(self.report, self.rec, join).bubble('onupdate', self.update));
            Array.forEach(join.Recs, function(rec) {
              self.add(2, My.Rec.create(rec).bubble('onupdate', self.update).bubble('ondelete', function(rec){self.rec_ondelete(rec, join)}));
            });
            self.add(2, My.AnotherJoinRecAnchor.create(join).bubble('onupdate', self.update));
          });
          if (! Array.isEmpty(self.rec.JOINS_TO))
            self.add(1, My.NewJoinAnchor.create(self.report, self.rec).bubble('onupdate', self.update));
          self.onresize();
        },
        //
        add:function(level, e) {
          var li = self.li('l' + level).add(e);
          if (level > 0)
            self.items.push(li);
        },
        update:function() {
          self.draw();
          self.onupdate();
        },
        rec_ondelete:function(rec, join) {
          join.drop(rec);
          self.update();
        }
      }
    })
  },
  AnotherJoinRecAnchor:{
    /*
     * @arg RepCritJoin join
     */
    create:function(join) {
      return Html.AnchorAction.create('red', 'Another...').extend(function(self) {
        return {
          onupdate:function() {},
          //
          onclick:function() {
            join.ajax().add(self.onupdate);
          }
        }
      })
    }
  },
  NewJoinAnchor:{
    /*
     * @arg ReportCriteria report
     * @arg RepCritRec rec
     */
    create:function(report, rec) {
      return Html.AnchorAction.create('Join red', 'add...').extend(function(self) {
        return {
          onupdate:function() {},
          //
          onclick:function() {
            NewJoinPop.pop(report, rec, self.onupdate);
          }
        }
      })
    }
  },
  JoinAnchor:{
    /*
     * @arg ReportCriteria report
     * @arg RepCritRec rec
     * @arg RepCritJoin join (optional)
     */
    create:function(report, rec, join) {
      var My = this;
      return Html.Span.create().extend(function(self) {
        return {
          onupdate:function() {},
          //
          init:function() {
            self.jointype = My.JoinTypeAnchor.create(report, rec, join).bubble('onupdate', self).into(self);
            self.count = My.CountAnchor.create(report, rec, join).bubble('onupdate', self).into(self);
            self.count.showIf(join.isCountType());
          }
        }
      })
    },
    JoinTypeAnchor:{
      create:function(report, rec, join) {
        return Html.AnchorAction.create('Join', join.getJoinTypeLabel()).extend(function(self) {
          return {
            onupdate:function() {},
            //
            onclick:function() {
              JoinTypePop.pop(self, join, self.onupdate);
            }
          }
        })
      }
    },
    CountAnchor:{
      create:function(report, rec, join) {
        return Html.AnchorAction.create('Ct', join.getCountLabel()).extend(function(self) {
          return {
            onupdate:function() {},
            //
            onclick:function() {
              JoinCountPop.pop(join, self.onupdate);
            }
          }
        })
      }      
    }
  },
  Rec:{
    /*
     * @arg RepCritRec rec
     */
    create:function(rec) {
      return Html.Span.create().extend(function(self) {
        return {
          onupdate:function() {},
          ondelete:function(rec) {},
          //
          init:function() {
            Html.Span.create('Record', rec._name).into(self);
            Html.Anchor.create('Summary', rec.summary(), self.anchor_onclick).into(self);
          },
          anchor_onclick:function() {
            rec.ajax().loadParInfo(self.pop);
          },
          //
          pop:function() {
            CritRecEntryPop.pop(rec).bubble('onsave', self.pop_onsave).bubble('ondelete', self.pop_ondelete);
          },
          pop_onsave:function(update) {
            rec = update;
            self.onupdate();
          },
          pop_ondelete:function() {
            self.ondelete(rec);
          }
        }
      })
    }
  }
}
/**
 * Panels ReportTablePanels
 *   ClientReportSplitTile Client
 *     ClientReportTable table (left)
 *     DenomReportTable tableDenom (right)
 *     Tile percentbar
 *   AuditReportTile Audit
 *     AuditReportTable table
 */
ReportTablePanels = {
  create:function(container) {
    var panels = {
      Client:ClientReportSplitTile, 
      Audit:AuditReportTile};
    return Html.Panels.create(Html.Tile.create(container, 'ReportTablePanels'), panels).extend(function(self) {
      return {
        load:function(report) {
          if (report.isTable_Audit()) 
            self.Panels.Audit.select();
          else 
            self.Panels.Client.select();
          self.selected.load(report);
        }
      }
    })
  }
}
/**
 * SplitTile CientReportSplitTile
 *   ClientReportTable table
 *   DenomReportTable tableDenom
 *   Tile percentBar
 */
ClientReportSplitTile = {
  create:function(container) {
    return Html.SplitTile.create(container).extend(function(self) {
      return {
        init:function() {
          self.table = ClientReportTable.create(self.left).bubble('onstats', self.table_onstats);
          self.tableDenom = DenomReportTable.create(self.right).bubble('onstats', self.tableDenom_onstats);
          self.percentBar = Html.Tile.create(container, 'PercentBar');
        },
        load:function(report) {
          if (report.isFractioned()) {
            self.showBoth();
            self.table.set('_ct', null).load(report);
            self.tableDenom.set('_ct', null).load(report);
            self.percentBar.nbsp().show();
          } else {
            self.showLeft();
            self.table.load(report);
            self.percentBar.hide();
          }
        },
        reset:function() {
          self.table.reset();
          self.tableDenom.reset();
        },
        setMaxHeight:function(i) {
          self.table.setMaxHeight(i);
          self.tableDenom.setMaxHeight(i);
        },
        table_onstats:function(length) {
          self.table._ct = length;
          self.setPct(length);
        },
        tableDenom_onstats:function(length) {
          self.tableDenom._ct = length;
          self.setPct(length);
        },
        setPct:function() {
          if (self.table._ct !== null && self.tableDenom._ct) {
            var pct = Math.roundTo(self.table._ct / self.tableDenom._ct * 100, 2);
            self.percentBar.setText('Total: ' + pct + '%');
          }
        }
      }
    })
  }
}
/**
 * Tile AuditReportTile
 */
AuditReportTile = {
  create:function(container) {
    return Html.Tile.create(container).extend(function(self) {
      return {
        init:function() {
          self.table = AuditReportTable.create(self);
        },
        load:function(report) {
          self.table.load(report);
        },
        reset:function() {
          self.table.reset();
        },
        setMaxHeight:function(i) {
          self.table.setMaxHeight(i);
        }
      }
    })
  }
}
/**
 * TableLoader ReportTable
 *   Tile statusbar
 */
ReportTable = {
  create:function(container) {
    var My = this;
    return Html.TableLoader.create(container, 'fsb').extend(My, function(self, parent) {
      return {
        onstats:function(length) {},
        onreqdownload:function() {},
        //
        init:function() {
          self.setHeight(350);
          self.statusbar = My.StatusBar.create(container, 'Stats').bubble('onreqdownload', self);
          self._pad = self.statusbar.getHeight();
        },
        load:function(report) {
          self.report = report;
          parent(Html.TableLoader).load();
        },
        hide:function() {
          self.statusbar.hide();
          parent(Html.ScrollTable).hide();
          return self;
        },
        show:function() {
          self.statusbar.show();
          parent(Html.ScrollTable).show();
          return self;
        },
        setMaxHeight:function(i) {
          self.setHeight(i - self._pad, 100);
        },
        //
        fetch:function(callback_recs) {
          self.report.ajax().generate(function(report) {
            callback_recs(self.getRecsFromReport(report));
          })
        },
        getRecsFromReport:function(report) {
          return report.recs;
        },
        reset:function() {
          self.thead().clean();
          parent(Html.TableLoader).reset();
        },
        setStats:function(recs) {
          if (self.isNumerator && isNumerator())
            self.statusbar.setText('Numerator record(s) returned: ' + recs.length);
          else
            self.statusbar.setText('Denominator record(s) returned: ' + recs.length);
          self.onstats(recs.length);
        }
      }
    })
  },
  StatusBar:{
    create:function(container) {
      return Html.Tile.create(container, 'Stats').extend(function(self) {
        return {
          onreqdownload:function() {},
          //
          init:function() {
            self.label = Html.Label.create().into(self);
            self.download = Html.Anchor.create('download').setText('Download').into(self).hide().bubble('onclick', self, 'onreqdownload');
            //self.cb = Html.CmdBar.create(self).append(self.label);
          },
          setText:function(text) {
            self.label.setText(text);
            self.download.show();
          }
        }
      })
    }
  }
}
/**
 * ReportTable ClientReportTable
 */
ClientReportTable = {
  create:function(container) {
    return ReportTable.create(container, 'fsb').extend(function(self) {
      return {
        init:function() {
          //self.sb.cb.button('Generate Reminders...', self.generate_onclick, 'send');
        },
        onreqdownload:function() {
          self.report.ajax().download(self.isNumerator());
        },
        isNumerator:function() {
          return true;
        },
        onload:function(recs) {
          var tr = self.thead().trFixed().th(self.report.Rec._name).w('20%');
          self.cw = String.percent(80 / recs.joinCt);
          recs.joinTables.forEach(function(table) {
            tr.th(table).w(self.cw);
          })
          self.setStats(recs);
        },
        add:function(rec, tr) {
          tr.td(AnchorClient_Facesheet.create(rec)).w('20%');
          rec.getJoinDatas().forEach(function(j) {
            tr.td().w(self.cw).html(j.labels.join('<br>'));
          })
        },
        generate_onclick:function() {
          GenRemindersPop.pop(self.recs);
        }
      }
    })
  }
}
/**
 * ClientReportTable DenomReportTable
 */
DenomReportTable = {
  create:function(container) {
    return ClientReportTable.create(container).extend(function(self) {
      return {
        getRecsFromReport:function(report) {
          return report.recsDenom;
        },
        isNumerator:function() {
          return false;
        }
      }
    })
  }
}
/**
 * ReportTable AuditReportTable
 */
AuditReportTable = {
  create:function(container) {
    var My = this;
    return ReportTable.create(container, 'fsb').extend(function(self) {
      return {
        onload:function(recs) {
          var tr = self.thead().trFixed().th('Audit Record').th('Date').th('User').th('Patient');
          var w = String.percent(60 / recs.joinCt);
          recs.joinTables.forEach(function(table) {
            tr.th(table).w(w);
          })
          self.setStats(recs);
        },
        onreqdownload:function() {
          self.report.ajax().download(true);
        },
        add:function(rec, tr) {
          tr.select(My.AnchorAudit.create(rec)).td(rec.date).td(rec.User.name).td(AnchorClient_Facesheet.create(rec.Client));
          rec.getJoinDatas().forEach(function(j) {
            tr.td().html(j.labels.join('<br>'));
          })
        },
        onselect:function(rec) {
          AuditViewer.pop(self.recs, rec);
        }
      }
    })
  },
  AnchorAudit:{
    create:function(rec, text) {
      text = text || rec._label;
      switch (rec.action) {
        case AuditRec.ACTION_REVIEW:
          return Html.AnchorAction.asView(text);
        case AuditRec.ACTION_DELETE:
          return Html.AnchorAction.asDelete(text);
        case AuditRec.ACTION_PRINT:
          return Html.AnchorAction.asPrint(text);
        case AuditRec.ACTION_BREAKGLASS:
          return Html.AnchorAction.asWarning(text);
        default:
          return Html.AnchorAction.asUpdate(text);
      }
    }
  }
}
/**
 * Pop AuditViewer
 */
AuditViewer = {
  pop:function(recs, rec) {
    return this.create().pop(recs, rec);
  },
  create:function() {
    var My = this;
    return AuditViewer = Html.Pop.create('Audit Viewer', 800).extend(function(self) {
      return {
        init:function() {
          self.navbar = My.NavBar.create(self.content).bubble('onselect', self.navbar_onselect);
          self.viewer = My.Viewer.create(self.content);
        },
        onshow:function(recs, rec) {
          self.navbar.load(recs, rec, My.AnchorAudit, true);
        },
        navbar_onselect:function(rec) {
          self.viewer.load(rec);
        }
      }
    })
  },
  NavBar:{
    create:function(container) {
      var My = this;
      return Html.NavBar.create(container).extend(function(self) {
        return {
          init:function() {
            self.onbox.content.hide();
            self.recbox = My.RecBox.create(self.onbox);
          },
          ondraw_load:function(rec, header, content) {
            header.html(rec.Client.name + '<br>' + rec._label);
            self.recbox.load(rec); 
          },
          getContent:function(rec) {
            var a = [];
            a.push(rec.recName + ' ID #' + rec.recId);
            a.push(rec.ACTIONS[rec.action] + ' ' + rec.date + ' by ' + rec.User.name);
            return a.join('<br>');
          }
        }
      })
    },
    RecBox:{
      create:function(container) {
        return Html.Tile.create(container, 'RecBox').extend(function(self) {
          return {
            init:function() {
              var ef = self.form = Html.EntryForm.create(self);
              ef.li('Record ID', null, 'nopad').ro('recId').lbl('User').ro('_by').lbl('Date').ro('date');
            },
            load:function(rec) {
              self.form.setRecord(rec);
            }
          }
        })
      }
    }
  },
  AnchorAudit:{
    create:function(rec, onclick) {
      return Html.AnchorRec.from(AuditReportTable.AnchorAudit.create(rec, rec.recName), rec, onclick);
    }
  },
  Viewer:{
    create:function(container) {
      var My = this;
      return Html.Tile.create(container, 'AuditViewer').extend(function(self) {
        return {
          init:function() {
            var tr = Html.Table.create(self).tbody().tr();
            self.before = My.Snapshot.create(Html.Pop.Frame.create(tr.td()._cell, 'Before')),
            self.after = My.Snapshot.create(Html.Pop.Frame.create(tr.td(null, 'pl5')._cell, 'After'))
          },
          load:function(rec) {
            self.before.load(rec.before);
            self.after.load(rec.after);
          }
        }
      })
    },
    Snapshot:{
      create:function(container) {
        return Html.Tile.create(container, 'Snapshot').extend(function(self) {
          return {
            init:function() {
              self.table = Html.Table.create().into(self).tbody();
            },
            load:function(rec) {
              self.table.clean();
              var snap = rec.getSnapshot();
              if (snap) 
                for (var fid in snap) 
                  self.table.tr().th(fid + ':').td(snap[fid]);
            }
          }
        })
      }
    }
  }
}
/**
 * JoinTypePop (dummy question pop)
 */
JoinTypePop = {
  /*
   * @arg <a> anchor of join
   * @arg RepCritJoin join
   * @arg fn() onupdate
   */
  pop:function(anchor, join, onupdate) {
    var jts = Map.invert(Map.extract(join.JTS, join.allowable()));
    Question.asDummy('Join Type', Map.keys(jts), join.JTS[join.jt]).popDeletable(
      function(key) {
        join.updateJoinType(jts[key]);
        onupdate();
      }, 
      function() {
        anchor.style.color = 'red';
        Pop.Confirm.showDeleteAlways('join', function(confirmed) {
          anchor.style.color = '';
          if (confirmed) {
            join.remove();
            onupdate();
          }
        })
      });
  }
}
/**
 * JoinCountPop (dummy question pop)
 */
JoinCountPop = {
  /*
   * @arg ReportCriteria report
   * @arg RepCritRec rec
   * @arg fn() onupdate
   */
  pop:function(join, onupdate) {
    var cts = [];
    for (var i = 1; i < 50; i++) 
      cts.push(String.from(i));
    Question.asDummy('Count', cts).pop(function(ct) {
      join.updateCount(ct);
      onupdate();
    })
  }
}
/**
 * JoinCountPop (dummy question pop)
 */
NewJoinPop = {
  /*
   * @arg ReportCriteria report
   * @arg RepCritRec rec
   * @arg fn() onupdate
   */
  pop:function(report, rec, onupdate) {
    var tables = Map.invert(Map.extract(RepCritRec.TABLES, report.Rec.JOINS_TO));
    Question.asDummy('Join Table', Map.keys(tables)).pop(function(key) {
      report.ajax().addJoin(rec, tables[key], onupdate);
    })
  }
}
/**
 * RecordEntryPop ReportEntryPop
 */
ReportEntryPop = {
  /*
   * @arg RepCritRec rec 
   * @arg string focusId (optional)
   */
  pop:function(rec, focusId) {
    return this.create().pop(rec, focusId);
  },
  create:function() {
    return ReportEntryPop = Html.RecordEntryDeletePop.create('Report Entry', 650).extend(function(self) {
      return {
        onsave:function(report) {},
        ondelete:function(id) {},
        //
        isDeletable:function(rec) {
          return rec.reportId != null;
        },
        buildForm:function(ef, rec) {
          ef.li('Name').textbox('name');
          ef.li('Description').textarea('comment', 10);
        },
        save:function(rec, onsuccess, onerror) {
          rec = self.rec.aug(rec);
          rec.ajax().save(onsuccess);
        },
        remove:function(rec, onsuccess) {
          ReportCriteria.ajax(self).remove(rec.reportId, onsuccess);
        },
        getDeleteNoun:function() {
          return 'report';
        }
      }
    })
  }
} 
/**
 * Pop GenRemindersPop
 */
GenRemindersPop = {
  /*
   * @arg Client_Rep recs 
   */
  pop:function(recs) {
    return this.create().pop(recs);
  },
  create:function() {
    return GenRemindersPop = Html.Pop.create('Generate Reminders').extend(function(self) {
      return {
        init:function() {
          self.input = Html.TextArea.create().setWidth(500).setRows(10).into(self.content);
          self.cb = Html.CmdBar.create(self.content).button('Send Now', self.send_onclick, 'send').cancel(self.close);
        },
        onshow:function(recs) {
        }
      }
    })
  }
}
/**
 * Pop NewReportTypePop
 *   Button[]
 */
NewReportTypePop = {
  /*
   * @callback(type)
   */
  pop:function(callback) {
    return this.create().pop(callback);
  },
  create:function() {
    var My = this;
    return NewReportTypePop = Html.Pop.create('New Report').extend(function(self) {
      return {
        init:function() {
          var frame = Html.Pop.Frame.create(self.content);
          for (var type in ReportCriteria.TYPES) 
            My.Button.create(frame, ReportCriteria.TYPES[type], self.button_onclick.curry(type));
          Html.CmdBar.create(self.content).cancel(self.close);
        },
        onshow:function(callback) {
          self.callback = callback;
        },
        button_onclick:function(type) {
          self.close();
          self.callback(type);
        }
      }
    })
  },
  Button:{
    create:function(container, text, onclick) {
      Html.Anchor.create('cmd rep', text, onclick).into(Html.Tile.create(container, 'cmd-fixed'));
    }
  }
}
/**
 * Pop CritRecEntryPop 
 *    CritRecForm form
 */ 
CritRecEntryPop = {
  /*
   * @arg RepCritRec rec 
   */
  pop:function(rec) {
    return this.create().pop(rec);
  },
  create:function() {
    return CritRecEntryPop = Html.Pop.create('Entry', 500).extend(function(self) {
      return {
        onsave:function(rec) {},
        ondelete:function() {},
        //
        init:function() {
          self.form = CritRecForm.create(self.content).bubble('onchange', self.form_onchange);
          self.cb = Html.CmdBar.create(self.content).ok(self.save_onclick).del(self.del_onclick).cancel(self.close);
        },
        pop:function(rec) {
          self.setCaption(rec._name + ' Criteria');
          self.dirty = false;
          self.form.load(rec);
          self.showPosCursor();
          self.cb.showDelIf(rec._name != 'Patients');
          return self;
        },
        //
        isDirty:function() {
          return self.dirty;
        },
        form_onchange:function() {
          self.dirty = true;
        },
        close:function(saved) {
          if (saved) 
            Pop.close(true);
          else
            Pop.Confirm.closeCheckDirty(self, self.save_onclick);
        },
        save_onclick:function() {
          self.onsave(self.form.getRec());
          self.close(true);
        },
        del_onclick:function() {
          Pop.Confirm.showDelete('criteria', function() {
            self.ondelete();
            self.close(true);
          })
        }
      }
    })
  }
} 
/**
 * Tile CritRecForm
 *   Table table
 *     CritValueEntry table.tr()
 *       Span label
 *       Select op
 *       Spans spans
 *         SpanSingle spanSingle
 *         SpanBetween spanBetween
 *         SpanBetweenDates spanBetweenDates
 *         SpanAge spanAge
 *         SpanSelect spanSelect
 *         SpanPicker spanPicker
 *         SpanRecPicker spanRecPicker
 */
CritRecForm = {
  create:function(container) {
    var My = this;
    return Html.Tile.create(container, 'CritRecEntry').extend(function(self) {
      return {
        onchange:function() {},
        //
        init:function() {
          self.table = Html.Table.create().into(self).tbody();
        },
        /*
         * @arg RepCritRec rec
         */
        load:function(rec) {
          self.rec = rec;
          self.table.clean();
          self.entries = [];
          var i = 0;
          rec.forEachValue(function(cv) {
            cv._parent = rec;
            self.entries.push(My.CritValueEntry.create(self.table.tr(), cv).bubble('onchange', self));
          })
        },
        /*
         * @return RepCritRec updated record
         */
        getRec:function() {
          self.entries.forEach(function(entry) {
            self.rec.update(entry.getValue());
          }) 
          return self.rec;
        }
      }
    })
  },
  CritValueEntry:{
    /*
     * @arg TrAppender tr
     * @arg RepCritValue cv 
     */
    create:function(tr, cv) {
      var My = this;
      return Html.Span.create('CritValueEntry').extend(function(self) {
        return {
          onchange:function() {},
          //
          init:function() {
            self.tr = tr._tr(); 
            tr.td(self.label = Html.Span.create('FidLabel'), 'Label');
            self.tdOp = tr.td(self.op = Html.Select.create().bubble('onset', self.toggle).bubble('onchange', self.toggle), 'Op')._cell;
            self.tdSpans = tr.td(self.spans = My.Spans.create().bubble('onchange', self), 'Spans')._cell;
            self.load(cv);
          },
          load:function(cv) {
            self.cv = cv;
            self.op.load(Map.extract(RepCritValue.OPS, cv.getFixedOps()), '');
            self.spans.load(cv);
            self.label.setText(cv._label);
            self.op.setValue(cv.op);
            self.spans.setValue(cv.value);
            return self;
          },
          getValue:function() {
            return self.cv.update(self.op.getValue(), self.spans.getValue());
          },
          //
          toggle:function() {
            self.tr.addClassIf('sel', self.op.getValue());
            self.spans.toggle(self.op.getValue());
            self.onchange();
          }
        }
      })
    },
    Spans:{
      create:function() {
        var My = this;
        return Html.Span.create().extend(function(self) {
          return {
            onchange:function() {},
            //
            init:function() {
              self.spans = [
                self.spanSingle = My.SpanSingle.create(self).bubble('onchange', self),
                self.spanBetween = My.SpanBetween.create(self).bubble('onchange', self),
                self.spanBetweenDates = My.SpanBetweenDates.create(self).bubble('onchange', self),
                self.spanAge = My.SpanAge.create(self).bubble('onchange', self),
                self.spanSelect = My.SpanSelect.create(self).bubble('onchange', self),
                self.spanPicker = My.SpanPicker.create(self).bubble('onchange', self),
                self.spanRecPicker = My.SpanRecPicker.create(self).bubble('onchange', self)];
              self.hide();
            },
            /*
             * @arg RepCritValue cv
             */
            load:function(cv) {
              self.cv = cv;
              if (cv.getFixedValues) {
                self.spanSelect.load(cv);
                self.showDefault = self.showSelect;
              } else if (cv.getRecPicker) {
                self.spanRecPicker.load(cv);
                self.showDefault = self.showRecPicker;
              } else if (cv.createPicker) {
                self.spanPicker.load(cv);
                self.showDefault = self.showPicker;
              } else { 
                self.showDefault = self.showSingle;
              }
            },
            toggle:function(op) {
              switch (op) {
                case '':
                  self.hide();
                  break;
                case RepCritValue.OP_BETWEEN:
                case RepCritValue.OP_AGERANGE:
                  self.showBetween();
                  break;
                case RepCritValue.OP_BETWEEN_DATES:
                  self.showBetweenDates();
                  break;
                case RepCritValue.OP_WITHIN:
                case RepCritValue.OP_OVER:
                  self.showAge();
                  break;
                case RepCritValue.OP_NULL:
                case RepCritValue.OP_NOT_NULL:
                  self.hide();
                  break;
                default:
                  self.showDefault();
              }
            },
            hide:function() {
              self.spans.forEach(function(span) {
                span.hide();
              })
              self.span = null;
            },
            showSingle:function() {
              self.hide();
              self.span = self.spanSingle.show(self.cv);
            },
            showBetween:function() {
              self.hide();
              self.span = self.spanBetween.show(self.cv);
            },
            showBetweenDates:function() {
              self.hide();
              self.span = self.spanBetweenDates.show(self.cv);
            },
            showAge:function() {
              self.hide();
              self.span = self.spanAge.show(self.cv);
            },
            showSelect:function() {
              self.hide();
              self.span = self.spanSelect.show(self.cv);
            },
            showPicker:function() {
              self.hide();
              self.span = self.spanPicker.show(self.cv);
            },
            showRecPicker:function() {
              self.hide();
              self.span = self.spanRecPicker.show(self.cv);
            },
            setValue:function(value) {
              if (self.span)
                self.span.setValue(value);
            },
            getValue:function() {
              if (self.span)
                return self.span.getValue();
            }
          }
        })  
      },
      SpanSingle:{
        create:function(container) {
          return Html.Span.create().into(container).extend(function(self) {
            return {
              onchange:function() {},
              //
              init:function() {
                self.input = Html.InputText.create().into(self).bubble('onchange', self);
              },
              show:function(cv) {
                Html._proto.show.call(self);
                self.cv = cv;
                self.input.setFocus();
                return self;
              },
              setValue:function(value) {
                self.input.setValue(value);
              },
              getValue:function() {
                self.cv.text_ = null;
                return self.input.getValue();
              }
            }
          })
        }
      },
      SpanBetween:{
        create:function(container) {
          return CritRecForm.CritValueEntry.Spans.SpanSingle.create(container).extend(function(self) {
            return {
              onchange:function() {},
              //
              init:function() {
                self.input.setSize(5);
                self.label = Html.Label.create('p5', '').into(self);
                self.input2 = Html.InputText.create(null).setSize(5).into(self).bubble('onchange', self);
              },
              setValue:function(value) {
                var a = value.split(',');
                self.input.setValue(a[0]);
                self.input2.setValue((a.length > 0) ? a[1] : null);
              },
              getValue:function(value) {
                self.cv.text_ = null;
                return [self.input.getValue(), self.input2.getValue()].join(',');
              }
            }
          })
        }
      },
      SpanBetweenDates:{
        create:function(container) {
          return Html.Span.create().into(container).extend(function(self) {
            return {
              onchange:function() {},
              //
              init:function() {
                self.input = Html.InputDate.create().into(self).bubble('onset', self.di_onset);
                self.label = Html.Label.create('p5', '').into(self);
                self.input2 = Html.InputDate.create().into(self).bubble('onset', self.di_onset);
              },
              show:function(cv) {
                Html._proto.show.call(self);
                self.cv = cv;
                self.input.setFocus();
                return self;
              },
              setValue:function(value) {
                var a = value.split(',');
                self.input.setValue(a[0]);
                self.input2.setValue((a.length > 0) ? a[1] : null);
              },
              getValue:function(value) {
                self.cv.text_ = null;
                return [self.input.getValue(), self.input2.getValue()].join(',');
              },
              //
              di_onset:function() {
                self.onchange();
              }
            }
          })
        }
      },
      SpanAge:{
        create:function(container) {
          var My = this;
          return CritRecForm.CritValueEntry.Spans.SpanSingle.create(container).extend(function(self) {
            return {
              onchange:function() {},
              //
              init:function() {
                self.input.setSize(5);
                self.input2 = Html.Select.create(My.Opts).setClass('ml5').into(self).bubble('onchange', self);
              },
              setValue:function(value) {
                var a = value.split(',');
                self.input.setValue(a[0]);
                self.input2.setValue((a.length > 0) ? a[1] : null);
              },
              getValue:function(value) {
                self.cv.text_ = self.input.getValue() + ' ' + self.input2.getText();
                return [self.input.getValue(), self.input2.getValue()].join(',');
              }
            }
          })
        },
        Opts:{'y':'year(s)','m':'month(s)','w':'week(s)','d':'day(s)'}
      },
      SpanSelect:{
        create:function(container) {
          return Html.Span.create().into(container).extend(function(self) {
            return {
              onchange:function() {},
              //
              load:function(cv) {
                self.cv = cv;
                self.select = Html.Select.create(cv.getFixedValues()).into(self).bubble('onchange', self.select_onchange);
                self._saveText();
                return self;
              },
              show:function(cv) {
                Html._proto.show.call(self);
                self.cv = cv;
                self.select.setFocus();
                return self;
              },
              setValue:function(value) {
                self.select.setValue(value);
                self._saveText();
              },
              getValue:function() {
                return self.select.getValue();
              },
              //
              _saveText:function() {
                self.cv.text_ = self.select.getText();
              },
              select_onchange:function() {
                self._saveText();
                self.onchange();
              }
            }
          })
        }
      },
      SpanPicker:{
        create:function(container) {
          return Html.Span.create().into(container).extend(function(self) {
            return {
              onchange:function() {},
              //
              load:function(cv) {
                self.cv = cv;
                self.picker = cv.createPicker(cv).into(self);
                return self;
              },
              show:function() {
                Html._proto.show.call(self);
                self.picker.setFocus();
                return self;
              },
              setValue:function(value) {
                self.picker.setValue(value);
              },
              getValue:function() {
                self.cv.text_ = null;
                return self.picker.getValue();
              }
            }
          })
        }
      },
      SpanRecPicker:{
        create:function(container) {
          return CritRecForm.CritValueEntry.Spans.SpanPicker.create(container).extend(function(self) {
            return {
              onchange:function() {},
              //
              load:function(cv) {
                self.cv = cv;
                self.picker = cv.getRecPicker().create().into(self).bubble('onset', self);
                if (self.picker.load) 
                  self.picker.load();
                return self;
              },
              setValue:function(value) {
                if (self.cv._rec)
                  self.picker.set(self.cv._rec);
                else
                  self.picker.setValueText(self.cv.value, self.cv.text_);
              },
              getValue:function() {
                return self.picker.getValue();
              },
              onset:function(rec) {
                self.cv.text_ = self.picker.getText();
                self.cv._rec = rec;
              }
            }
          })
        }
      }
    }
  }
}