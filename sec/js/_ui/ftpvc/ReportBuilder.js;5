/**
 * Tile ReportStubView
 *   TableLoader table
 *   CmdBar cb
 */
ReportStubView = {
  create:function(container) {
    var My = this;
    return Html.Tile.create(container, 'ReportStubView').extend(function(self) {
      return {
        onselect:function(stub) {},
        oncreate:function(report) {},
        //
        init:function() {
          self.table = My.Table.create(self).bubble('onselect', self);
          self.cb = Html.CmdBar.create(self).add('New Report...', self.add_onclick);
          self._pad = self.cb.height();
          self.load();
        },
        load:function() {
          self.table.load();
        },
        setMaxHeight:function(i) {
          self.table.setMaxHeight(i - self._pad);
        },
        //
        add_onclick:function() {
          NewReportTypePop.pop(self.newReport);
        },
        newReport:function(tableId) {
          self.working(function() {
            Ajax.Reporting.newReport(tableId, function(report) {
              self.working(false);
              self.oncreate(report);
            })
          })
        }
      }
    })
  },
  Table:{
    create:function(container) {
      return Html.TableLoader.create(container, 'fsy grid').extend(function(self) {
        return {
          onselect:function(report) {},
          //
          init:function() {
            self.thead().trFixed().th('Type').w('10%').th('Name').w('25%').th('Description').w('65%');
          },
          //
          rowKey:function(rec) {
            return rec.reportId; 
          },
          rowBreaks:function(rec) {
            return [rec._table];
          },
          fetch:function(callback_recs) {
            Ajax.Reporting.getStubs(callback_recs);
          },
          add:function(report, tr) {
            tr.td(report._table, 'fs').select(Html.AnchorAction.create('Report', report.name)).td(report.comment, 'comment');
          },
          setMaxHeight:function(i) {
            self.setHeight(i);
          }
        }
      })
    }
  }
}
NewReportTypePop = {
  /*
   * @callback(tableId)
   */
  pop:function(callback) {
    var types = Map.invert(Map.extract(RepCritRec.TABLES, RepCritRec.CREATABLE));
    Question.asDummy('Report Type', Map.keys(types)).pop(function(type) {
      callback(types[type]);
    })
  }
}
/**
 * Tile ReportView
 *   Tile header
 *   ReportTable table
 */
ReportView = {
  create:function(container) {
    var My = this;
    return Html.Tile.create(container, 'ReportView').extend(function(self) {
      return {
        onedit:function(report) {},
        onexit:function() {},
        //
        init:function() {
          self.header = My.Header.create(self).bubble('onedit', self).bubble('onexit', self);
          self.table = ReportTablePanels.create(self);
        },
        loadFromStub:function(stub) {
          self.reset();
          self.working(function() {
            Ajax.Reporting.getReport(stub.reportId, self.load);
          })
        },
        setMaxHeight:function(i) {
          i = (i) ? self._padContainer = i : self._padContainer;
          self._pad = self.header.getHeight();
          self.table.setMaxHeight(i - self._pad);
        },
        reset:function() {
          self.table.reset();
          self.header.reset();
        },
        /*
         * @arg ReportCriteria report
         */
        load:function(report) {
          self.reset();
          self.working(false);
          self.report = report;
          self.header.load(report);
          self.table.load(report);
          self.setMaxHeight();
        }
      }
    })
  },
  Header:{
    create:function(container) {
      return Html.Tile.create(container, 'ReportViewHeader').extend(function(self) {
        return {
          onedit:function(report) {},
          onexit:function() {},
          //
          init:function() {
            var t = Html.Table2Col.create(self);
            Html.TableCol.create(t.left, [
              self.h2 = Html.H2.create('Report').nbsp(),
              self.comment = Html.Div.create('Comment').setText('Description')]);
            self.custom = Html.AnchorAction.asCustom('Configure this report').into(t.right).bubble('onclick', self.custom_onclick);
            self.exit = Html.AnchorAction.create('back', 'Return to list').into(t.right).bubble('onclick', self, 'onexit');
            self.summary = Html.Div.create().into(self).setText('Summary');
          },
          reset:function() {
            self.invisible();
          },
          load:function(report) {
            self.report = report;
            self.h2.setText(report.name);
            self.comment.setText(report.comment);
            self.summary.html(report.summary('<br>&bull; '));
            self.visible();
          },
          //
          custom_onclick:function() {
            self.onedit(self.report);
          }
        }
      })
    }
  }
}
/**
 * Tile ReportCriteriaView 
 *   TreeTile tree
 *   ReportTable table
 */
ReportCriteriaView = {
  create:function(container) {
    My = this;
    return Html.Tile.create(container, 'ReportCriteriaView').extend(function(self) {
      return {
        onexit:function() {},
        //
        init:function() {
          var split = Html.SplitTile.create(self);
          self.reportAnchor = My.ReportAnchor.create().into(split.left).bubble('onsave', self.report_onsave).bubble('ondelete', self.close.bind(true));
          self.denomAnchor = My.DenomAnchor.create().into(split.right).bubble('onupdate', self.denom_onupdate);
          self.tree = My.TreeTile.create(Html.Tile.create(self, 'TreeTile')).bubble('onresize', self.tree_resize).bubble('onupdate', self.tree_onupdate).bubble('ondelete', self.close.bind(true)).bubble('onsave', self.onsave);
          self.cb = Html.CmdBar.create(self).button('Generate Report', self.generate_onclick, 'report').lbl('').save(self.save_onclick).del(self.del_onclick, 'Delete Report').exit(self.close).container();
          self.tile = Html.Tile.create(self, 'mt10');
          self.table = ReportTablePanels.create(self.tile).hide();
        },
        /*
         * @arg ReportCriteria report
         */
        load:function(report) {
          self.setDirty(false);
          self.table.hide();
          if (report == null) 
            self.working(function() {
              Ajax.Reporting.newReport(function(report) {
                self.working(false);
                self.setReport(report);
              });
            })
          else
            self.setReport(report);
        },
        setReport:function(report) {
          self.report = report;
          self.reportAnchor.load(report);
          self.denomAnchor.load(report);
          self.tree.load(report);
        },
        //
        save:function(callback) {
          self.working(function() {
            Ajax.Reporting.save(self.report, function(report) {
              self.working(false);
              self.load(report);
              callback();
            })
          })
        },
        close:function(saved) {
          if (saved || ! self.dirty)
            self.onexit();
          else
            Pop.Confirm.showDirtyExit(self.saveAndExit, self.onexit);
        },
        generate_onclick:function() {
          self.table.show().load(self.report);
        },
        save_onclick:function() {
          self.working(function() {
            self.save(self.onsave);
          })
        },
        onsave:function() {
          Html.Animator.fade(self.tree);
        },
        del_onclick:function() {
          Pop.Confirm.showDelete('report', function() {
            self.working(function() {
              Ajax.Reporting.deleteReport(self.report.reportId, function() {
                self.working(false);
                self.close(true);
              })
            })
          })
        },
        setDirty:function(value) {
          self.dirty = value;
          self.reportAnchor.setDirty(value);
        },
        tree_onupdate:function() {
          self.setDirty(true);
        },
        denom_onupdate:function() {
          self.tree.load(self.report);
          self.setDirty(true);
        },
        saveAndExit:function() {
          self.save(self.close);
        },
        exit_onclick:function() {
          self.onexit();
        },
        resize:function(pad) {
        },
        tree_resize:function(expanded) {
          Html.Window.flickerFixedRows();
        },
        report_onsave:function(report) {
          self.setReport(report);
          self.onsave();
        }
      }
    })
  },
  DenomAnchor:{
    create:function() {
      return Html.Span.create().extend(function(self) {
        return {
          onupdate:function() {},
          //
          init:function() {
            self.add = Html.AnchorAction.create('AddDenom', 'Add Denominator...').into(self).bubble('onclick', self.add_onclick);
            self.remove = Html.AnchorAction.create('Denom', 'Denominator').into(self).bubble('onclick', self.remove_onclick);
          },
          load:function(report) {
            self.report = report;
            self.draw();
          },
          draw:function() {
            if (self.report.isTypeFraction()) {
              self.add.hide();
              self.remove.show();
            } else {
              self.add.show();
              self.remove.hide();
            }
          },
          //
          add_onclick:function() {
            self.report.addDenom();
            self.draw();
            self.onupdate();
          },
          remove_onclick:function() {
            Pop.Confirm.showDelete('denominator', function() {
              self.report.removeDenom();
              self.draw();
              self.onupdate();
            })
          }
        }
      })
    }
  },
  ReportAnchor:{
    /*
     * @arg ReportCriteria report
     */
    create:function() {
      return Html.Span.create().extend(function(self) {
        return {
          onpop:function() {},
          onsave:function(report) {},
          ondelete:function() {},
          //
          init:function() {
            self.reportAnchor = Html.AnchorAction.create('Report').into(self).bubble('onclick', self.pop);
            self.commentAnchor = Html.Anchor.create('ml5').into(self).bubble('onclick', self.pop.bind(self, 'comment'));
          },
          load:function(report) {
            self.report = report;
            self.reportAnchor.setText(report.name);
            self.commentAnchor.setText(report.comment || '(No Description)');
          },
          pop:function(focusId) {
            self.onpop();
            return ReportEntryPop.pop(self.report, focusId).bubble('onsave', self).bubble('ondelete', self);
          },
          setDirty:function(value) {
            self.reportAnchor.addClassIf('dirty', value);
            self.reportAnchor.tooltip(value ? 'Report has unsaved changes' : null);
          }
        }
      })
    }
  },
  TreeTile:{
    create:function(container) {
      return Html.SplitTile.create(container).extend(function(self) {
        return {
          onresize:function() {},
          onupdate:function() {},
          onsave:function() {},
          //
          init:function() {
            self.tree = ReportTree.create(self.left).bubble('onresize', self).bubble('onupdate', self).bubble('onsave', self);
            self.treeDenom = ReportTree.create(self.right).bubble('onresize', self).bubble('onupdate', self).bubble('onsave', self);
          },
          load:function(report) {
            self.tree.load(report, report.Rec);
            if (report.isTypeFraction()) {
              self.treeDenom.load(report, report.RecDenom);
              self.showBoth();
            } else {
              self.showLeft();
            }
          }
        }
      })
    }
  }
}
/**
 * Ul ReportTree
 */
ReportTree = {
  create:function(container) {
    var My = this;
    return Html.Ul.create().into(container).extend(function(self) {
      return {
        onresize:function() {},
        onupdate:function() {},
        onsave:function() {},
        //
        /*
         * @arg ReportCriteria report
         * @arg Rec rec (e.g. report.Rec or report.RecDenom)
         */
        load:function(report, rec) {
          self.report = report;
          self.rec = rec;
          self.draw();
        },
        draw:function() {
          self.clean();
          self.items = [];
          self.add(1, My.Rec.create(self.rec).bubble('onupdate', self.update));
          Array.forEach(self.rec.Joins, function(join) {
            self.add(1, My.JoinAnchor.create(self.report, self.rec, join).bubble('onupdate', self.update));
            Array.forEach(join.Recs, function(rec) {
              self.add(2, My.Rec.create(rec).bubble('onupdate', self.update).bubble('ondelete', function(rec){self.rec_ondelete(rec, join)}));
            });
            self.add(2, My.AnotherJoinRecAnchor.create(join).bubble('onupdate', self.update));
          });
          if (! Array.isEmpty(self.rec.JOINS_TO))
            self.add(1, My.JoinAnchor.create(self.report, self.rec).bubble('onupdate', self.update));
          self.onresize();
        },
        //
        add:function(level, e) {
          var li = self.li('l' + level).add(e);
          if (level > 0)
            self.items.push(li);
        },
        update:function() {
          self.draw();
          self.onupdate();
        },
        rec_ondelete:function(rec, join) {
          join.drop(rec);
          self.update();
        }
      }
    })
  },
  AnotherJoinRecAnchor:{
    /*
     * @arg RepCritJoin join
     */
    create:function(join) {
      return Html.AnchorAction.create('red', 'Another...').extend(function(self) {
        return {
          onupdate:function() {},
          //
          onclick:function() {
            Ajax.Reporting.getJoin(join.table, function(j) {
              overlayWorking(false);
              join.add(RepCritRec.revive(j.Recs[0]));
              self.onupdate();
            })
          }
        }
      })
    }
  },
  JoinAnchor:{
    /*
     * @arg ReportCriteria report
     * @arg RepCritRec rec
     * @arg RepCritJoin join (optional)
     */
    create:function(report, rec, join) {
      var text = (join) ? join.getJoinTypeLabel() : 'add...';
      var cls = (join) ? 'Join' : 'Join red';
      return Html.AnchorAction.create(cls, text).extend(function(self) {
        return {
          onupdate:function() {},
          //
          onclick:function() {
            if (join)
              JoinTypePop.pop(join, self.onupdate);
            else
              NewJoinPop.pop(report, rec, self.onupdate);
          }
        }
      })
    }
  },
  Rec:{
    /*
     * @arg RepCritRec rec
     */
    create:function(rec) {
      return Html.Span.create().extend(function(self) {
        return {
          onupdate:function() {},
          ondelete:function(rec) {},
          //
          init:function() {
            Html.Span.create('Record', rec._name).into(self);
            Html.Anchor.create('Summary', rec.summary(), self.anchor_onclick).into(self);
          },
          anchor_onclick:function() {
            if (rec.pid_ && rec._prototype.pi == null) {
              Page.work(function() {
                Ajax.Templates.getParInfo(rec.pid_, function(pi) {
                  Page.work(false);
                  x.x
                  rec._prototype.pi = pi;
                  self.pop();
                })
              })
            } else {
              self.pop();
            }
          },
          //
          pop:function() {
            CritRecEntryPop.pop(rec).bubble('onsave', self.pop_onsave).bubble('ondelete', self.pop_ondelete);
          },
          pop_onsave:function(update) {
            rec = update;
            self.onupdate();
          },
          pop_ondelete:function() {
            self.ondelete(rec);
          }
        }
      })
    }
  }
}
/**
 * Panels ReportTablePanels
 */
ReportTablePanels = {
  create:function(container) {
    var panels = {
      Client:ClientReportTile, 
      Audit:AuditReportTile};
    return Html.Panels.create(container, panels).extend(function(self) {
      return {
        load:function(report) {
          if (report.isTable(RepCritRec.T_AUDITS)) 
            self.Panels.Audit.select();
          else 
            self.Panels.Client.select();
          self.selected.load(report);
        }
      }
    })
  }
}
/**
 * Tile AuditReportTile
 */
AuditReportTile = {
  create:function(container) {
    return Html.Tile.create(container).extend(function(self) {
      return {
        init:function() {
          self.table = AuditReportTable.create(self);
        },
        load:function(report) {
          self.table.load(report);
        },
        reset:function() {
          self.table.reset();
        },
        setMaxHeight:function(i) {
          self.table.setMaxHeight(i);
        }
      }
    })
  }
}
/**
 * SplitTile CientReportTile
 *   ClientReportTable table
 *   DenomReportTable tableDenom
 */
ClientReportTile = {
  create:function(container) {
    return Html.SplitTile.create(container).setClass('split').extend(function(self) {
      return {
        init:function() {
          self.table = ClientReportTable.create(self.left).bubble('onstats', self.table_onstats);
          self.tableDenom = DenomReportTable.create(self.right).bubble('onstats', self.tableDenom_onstats);
          self.percentBar = Html.Tile.create(container, 'PercentBar');
        },
        load:function(report) {
          if (report.isTypeFraction()) {
            self.showBoth();
            self.table.set('_ct', null).load(report);
            self.tableDenom.set('_ct', null).load(report);
            self.percentBar.show();
          } else {
            self.showLeft();
            self.table.load(report);
            self.percentBar.hide();
          }
        },
        reset:function() {
          self.table.reset();
          self.tableDenom.reset();
        },
        setMaxHeight:function(i) {
          self.table.setMaxHeight(i);
          self.tableDenom.setMaxHeight(i);
        },
        table_onstats:function(length) {
          self.table._ct = length;
          self.setPct(length);
        },
        tableDenom_onstats:function(length) {
          self.tableDenom._ct = length;
          self.setPct(length);
        },
        setPct:function() {
          if (self.table._ct && self.tableDenom._ct) {
            var pct = Math.roundTo(self.table._ct / self.tableDenom._ct * 100, 2);
            self.percentBar.setText('Total: ' + pct + '%');
          }
        }
      }
    })
  }
}
/**
 * TableLoader ReportTable
 *   Tile sb
 */
ReportTable = {
  create:function(container) {
    var My = this;
    return Html.TableLoader.create(container, 'fsb').extend(My, function(self, parent) {
      return {
        onstats:function(length) {},
        //
        init:function() {
          self.setHeight(350);
          self.sb = My.StatusBar.create(container, 'Stats');
          self._pad = self.sb.getHeight();
        },
        load:function(report) {
          self.report = report;
          parent(Html.TableLoader).load(report);
        },
        hide:function() {
          self.sb.hide();
          parent(Html.ScrollTable).hide();
          return self;
        },
        show:function() {
          self.sb.show();
          parent(Html.ScrollTable).show();
          return self;
        },
        setMaxHeight:function(i) {
          self.setHeight(i - self._pad, 100);
        },
        //
        fetch:function(callback_recs) {
          Ajax.Reporting.generate(self.report, function(report) {
            callback_recs(self.getRecsFromReport(report));
          })
        },
        getRecsFromReport:function(report) {
          return report.recs;
        },
        reset:function() {
          self.thead().clean();
          parent(Html.TableLoader).reset();
        },
        setStats:function(recs) {
          self.sb.setText('Total record(s) returned: ' + recs.length);
          self.onstats(recs.length);
        }
      }
    })
  },
  StatusBar:{
    create:function(container) {
      return Html.Tile.create(container, 'Stats').extend(function(self) {
        return {
          init:function() {
            self.label = Html.Label.create();
            self.cb = Html.CmdBar.create(self).append(self.label);
          },
          setText:function(text) {
            self.label.setText(text);
          }
        }
      })
    }
  }
}
/**
 * ReportTable ClientReportTable
 */
ClientReportTable = {
  create:function(container) {
    return ReportTable.create(container, 'fsb').extend(function(self) {
      return {
        init:function() {
          //self.sb.cb.button('Generate Reminders...', self.generate_onclick, 'send');
        },
        onload:function(recs) {
          var tr = self.thead().trFixed().th(self.report.Rec._name);
          var w = String.percent(80 / recs.joinCt);
          recs.joinTables.forEach(function(table) {
            tr.th(table).w(w);
          })
          self.setStats(recs);
        },
        add:function(rec, tr) {
          tr.td(AnchorClient_Facesheet.create(rec));
          rec.getJoinDatas().forEach(function(j) {
            tr.td().html(j.labels.join('<br>'));
          })
        },
        generate_onclick:function() {
          GenRemindersPop.pop(self.recs);
        }
      }
    })
  }
}
/**
 * ClientReportTable DenomReportTable
 */
DenomReportTable = {
  create:function(container) {
    return ClientReportTable.create(container).extend(function(self) {
      return {
        getRecsFromReport:function(report) {
          return report.recsDenom;
        }
      }
    })
  }
}
/**
 * ReportTable AuditReportTable
 */
AuditReportTable = {
  create:function(container) {
    var My = this;
    return ReportTable.create(container, 'fsb').extend(function(self) {
      return {
        onload:function(recs) {
          var tr = self.thead().trFixed().th('Audit Record').th('Date').th('User').th('Patient');
          var w = String.percent(60 / recs.joinCt);
          recs.joinTables.forEach(function(table) {
            tr.th(table).w(w);
          })
          self.setStats(recs);
        },
        add:function(rec, tr) {
          tr.select(My.AnchorAudit.create(rec)).td(rec.date).td(rec.User.name).td(AnchorClient_Facesheet.create(rec.Client));
          rec.getJoinDatas().forEach(function(j) {
            tr.td().html(j.labels.join('<br>'));
          })
        },
        onselect:function(rec) {
          AuditViewer.pop(self.recs, rec);
        }
      }
    })
  },
  AnchorAudit:{
    create:function(rec, text) {
      text = text || rec._label;
      switch (rec.action) {
        case AuditRec.ACTION_REVIEW:
          return Html.AnchorAction.asView(text);
        case AuditRec.ACTION_DELETE:
          return Html.AnchorAction.asDelete(text);
        case AuditRec.ACTION_PRINT:
          return Html.AnchorAction.asPrint(text);
        case AuditRec.ACTION_BREAKGLASS:
          return Html.AnchorAction.asWarning(text);
        default:
          return Html.AnchorAction.asUpdate(text);
      }
    }
  }
}
/**
 * Pop AuditViewer
 */
AuditViewer = {
  pop:function(recs, rec) {
    return this.create().pop(recs, rec);
  },
  create:function() {
    var My = this;
    return AuditViewer = Html.Pop.create('Audit Viewer', 800).extend(function(self) {
      return {
        init:function() {
          self.navbar = My.NavBar.create(self.content).bubble('onselect', self.navbar_onselect);
          self.viewer = My.Viewer.create(self.content);
        },
        onshow:function(recs, rec) {
          self.navbar.load(recs, rec, My.AnchorAudit, true);
        },
        navbar_onselect:function(rec) {
          self.viewer.load(rec);
        }
      }
    })
  },
  NavBar:{
    create:function(container) {
      var My = this;
      return Html.NavBar.create(container).extend(function(self) {
        return {
          init:function() {
            self.onbox.content.hide();
            self.recbox = My.RecBox.create(self.onbox);
          },
          ondraw_load:function(rec, header, content) {
            header.html(rec.Client.name + '<br>' + rec._label);
            self.recbox.load(rec); 
          },
          getContent:function(rec) {
            var a = [];
            a.push(rec.recName + ' ID #' + rec.recId);
            a.push(rec.ACTIONS[rec.action] + ' ' + rec.date + ' by ' + rec.User.name);
            return a.join('<br>');
          }
        }
      })
    },
    RecBox:{
      create:function(container) {
        return Html.Tile.create(container, 'RecBox').extend(function(self) {
          return {
            init:function() {
              var ef = self.form = Html.EntryForm.create(self);
              ef.li('Record ID', null, 'nopad').ro('recId').lbl('User').ro('_by').lbl('Date').ro('date');
            },
            load:function(rec) {
              self.form.setRecord(rec);
            }
          }
        })
      }
    }
  },
  AnchorAudit:{
    create:function(rec, onclick) {
      return Html.AnchorRec.from(AuditReportTable.AnchorAudit.create(rec, rec.recName), rec, onclick);
    }
  },
  Viewer:{
    create:function(container) {
      var My = this;
      return Html.Tile.create(container, 'AuditViewer').extend(function(self) {
        return {
          init:function() {
            var tr = Html.Table.create(self).tbody().tr();
            self.before = My.Snapshot.create(Html.Pop.Frame.create(tr.td()._cell, 'Before')),
            self.after = My.Snapshot.create(Html.Pop.Frame.create(tr.td(null, 'pl5')._cell, 'After'))
          },
          load:function(rec) {
            self.before.load(rec.before);
            self.after.load(rec.after);
          }
        }
      })
    },
    Snapshot:{
      create:function(container) {
        return Html.Tile.create(container, 'Snapshot').extend(function(self) {
          return {
            init:function() {
              self.table = Html.Table.create().into(self).tbody();
            },
            load:function(rec) {
              self.table.clean();
              var snap = rec.getSnapshot();
              if (snap) 
                for (var fid in snap) 
                  self.table.tr().th(fid + ':').td(snap[fid]);
            }
          }
        })
      }
    }
  }
}
/**
 * Join pops
 */
JoinTypePop = {
  /*
   * @arg RepCritJoin join
   * @arg fn() onupdate
   */
  pop:function(join, onupdate) {
    var jts = Map.invert(Map.extract(join.JTS, join.allowable()));
    Question.asDummy('Join Type', Map.keys(jts), join.JTS[join.jt]).popToggle(function(key) {
      join.update(jts[key]);
      onupdate();
    })
  }
}
NewJoinPop = {
  /*
   * @arg ReportCriteria report
   * @arg RepCritRec rec
   * @arg fn() onupdate
   */
  pop:function(report, rec, onupdate) {
    var tables = Map.invert(Map.extract(RepCritRec.TABLES, report.Rec.JOINS_TO));
    Question.asDummy('Join Table', Map.keys(tables)).pop(function(key) {
      overlayWorking(true);
      Ajax.Reporting.getJoin(tables[key], function(join) {
        overlayWorking(false);
        report.addJoin(rec, join);  
        onupdate();
      })
    })
  }
}
/**
 * RecordEntryPop ReportEntryPop
 */
ReportEntryPop = {
  /*
   * @arg RepCritRec rec 
   * @arg string focusId (optional)
   */
  pop:function(rec, focusId) {
    return this.create().pop(rec, focusId);
  },
  create:function() {
    return ReportEntryPop = Html.RecordEntryDeletePop.create('Report Entry', 500).extend(function(self) {
      return {
        onsave:function(report) {},
        ondelete:function(id) {},
        //
        isDeletable:function(rec) {
          return rec.reportId != null;
        },
        buildForm:function(ef, rec) {
          ef.li('Name').textbox('name');
          ef.li('Description').textarea('comment');
        },
        save:function(rec, onsuccess, onerror) {
          rec = self.rec.aug(rec);
          Ajax.Reporting.save(rec, onsuccess, onerror);
        },
        remove:function(rec, onsuccess) {
          Ajax.Reporting.deleteReport(rec.reportId, onsuccess);
        },
        getDeleteNoun:function() {
          return 'report';
        }
      }
    })
  }
} 
/**
 * Pop CritRecEntryPop 
 */ 
CritRecEntryPop = {
  /*
   * @arg RepCritRec rec 
   */
  pop:function(rec) {
    return this.create().pop(rec);
  },
  create:function() {
    return CritRecEntryPop = Html.Pop.create('Entry', 500).extend(function(self) {
      return {
        onsave:function(rec) {},
        ondelete:function() {},
        //
        init:function() {
          self.form = CritRecForm.create(self.content).bubble('onchange', self.form_onchange);
          self.cb = Html.CmdBar.create(self.content).ok(self.save_onclick).del(self.del_onclick).cancel(self.close);
        },
        pop:function(rec) {
          self.setCaption(rec._name + ' Criteria');
          self.dirty = false;
          self.form.load(rec);
          self.showPosCursor();
          self.cb.showDelIf(rec._name != 'Patients');
          return self;
        },
        //
        isDirty:function() {
          return self.dirty;
        },
        form_onchange:function() {
          self.dirty = true;
        },
        close:function(saved) {
          if (saved) 
            Pop.close(true);
          else
            Pop.Confirm.closeCheckDirty(self, self.save_onclick);
        },
        save_onclick:function() {
          self.onsave(self.form.getRec());
          self.close(true);
        },
        del_onclick:function() {
          Pop.Confirm.showDelete('criteria', function() {
            self.ondelete();
            self.close(true);
          })
        }
      }
    })
  }
} 
/**
 * Tile CritRecForm
 */
CritRecForm = {
  create:function(container) {
    var My = this;
    return Html.Tile.create(container, 'CritRecEntry').extend(function(self) {
      return {
        onchange:function() {},
        //
        init:function() {
          self.table = Html.Table.create().into(self).tbody();
        },
        /*
         * @arg RepCritRec rec
         */
        load:function(rec) {
          self.rec = rec;
          self.table.clean();
          self.entries = [];
          var i = 0;
          rec.forEachValue(function(cv) {
            self.entries.push(My.CritValueEntry.create(self.table.tr(), cv).bubble('onchange', self));
          })
        },
        /*
         * @return RepCritRec updated record
         */
        getRec:function() {
          self.entries.forEach(function(entry) {
            self.rec.update(entry.getValue());
          }) 
          return self.rec;
        }
      }
    })
  },
  CritValueEntry:{
    /*
     * @arg TrAppender tr
     * @arg RepCritValue cv 
     */
    create:function(tr, cv) {
      var My = this;
      return Html.Span.create('CritValueEntry').extend(function(self) {
        return {
          onchange:function() {},
          //
          init:function() {
            self.tr = tr._tr(); 
            tr.td(self.label = Html.Span.create('FidLabel'), 'Label');
            self.tdOp = tr.td(self.op = Html.Select.create().bubble('onset', self.toggle).bubble('onchange', self.toggle), 'Op')._cell;
            self.tdSpans = tr.td(self.spans = My.Spans.create().bubble('onchange', self), 'Spans')._cell;
            self.load(cv);
          },
          load:function(cv) {
            self.cv = cv;
            self.op.load(Map.extract(RepCritValue.OPS, cv.getFixedOps()), '');
            self.spans.load(cv);
            self.label.setText(cv._label);
            self.op.setValue(cv.op);
            self.spans.setValue(cv.value);
            return self;
          },
          getValue:function() {
            return self.cv.update(self.op.getValue(), self.spans.getValue());
          },
          //
          toggle:function() {
            self.tr.addClassIf('sel', self.op.getValue());
            self.spans.toggle(self.op.getValue());
            self.onchange();
          }
        }
      })
    },
    Spans:{
      create:function() {
        var My = this;
        return Html.Span.create().extend(function(self) {
          return {
            onchange:function() {},
            //
            init:function() {
              self.spanSingle = My.SpanSingle.create(self).bubble('onchange', self);
              self.spanBetween = My.SpanBetween.create(self).bubble('onchange', self);
              self.spanSelect = My.SpanSelect.create(self).bubble('onchange', self);
              self.spanPicker = My.SpanPicker.create(self).bubble('onchange', self);
              self.spanRecPicker = My.SpanRecPicker.create(self).bubble('onchange', self);
              self.hide();
            },
            /*
             * @arg RepCritValue cv
             */
            load:function(cv) {
              self.cv = cv;
              if (cv.getFixedValues) {
                self.spanSelect.load(cv);
                self.showDefault = self.showSelect;
              } else if (cv.getRecPicker) {
                self.spanRecPicker.load(cv);
                self.showDefault = self.showRecPicker;
              } else if (cv.getPicker) {
                self.spanPicker.load(cv);
                self.showDefault = self.showPicker;
              } else { 
                self.showDefault = self.showSingle;
              }
            },
            toggle:function(op) {
              switch (op) {
                case '':
                  self.hide();
                  break;
                case RepCritValue.OP_BETWEEN:
                case RepCritValue.OP_AGERANGE:
                  self.showBetween();
                  break;
                case RepCritValue.OP_NULL:
                case RepCritValue.OP_NOT_NULL:
                  self.hide();
                  break;
                default:
                  self.showDefault();
              }
            },
            hide:function() {
              self.spanSingle.hide();
              self.spanBetween.hide();
              self.spanSelect.hide();
              self.spanRecPicker.hide();
              self.spanPicker.hide();
              self.span = null;
            },
            showSingle:function() {
              self.spanBetween.hide();
              self.spanSelect.hide();
              self.spanRecPicker.hide();
              self.spanPicker.hide();
              self.span = self.spanSingle.show();
            },
            showBetween:function() {
              self.spanSingle.hide();
              self.spanSelect.hide();
              self.spanRecPicker.hide();
              self.spanPicker.hide();
              self.span = self.spanBetween.show();
            },
            showSelect:function() {
              self.spanSingle.hide();
              self.spanBetween.hide();
              self.spanRecPicker.hide();
              self.spanPicker.hide();
              self.span = self.spanSelect.show();
            },
            showPicker:function() {
              self.spanSingle.hide();
              self.spanBetween.hide();
              self.spanSelect.hide();
              self.spanRecPicker.hide();
              self.span = self.spanPicker.show();
            },
            showRecPicker:function() {
              self.spanSingle.hide();
              self.spanBetween.hide();
              self.spanSelect.hide();
              self.spanPicker.hide();
              self.span = self.spanRecPicker.show();
            },
            setValue:function(value) {
              if (self.span)
                self.span.setValue(value);
            },
            getValue:function() {
              if (self.span)
                return self.span.getValue();
            }
          }
        })  
      },
      SpanSingle:{
        create:function(container) {
          return Html.Span.create().into(container).extend(function(self) {
            return {
              onchange:function() {},
              //
              init:function() {
                self.input = Html.InputText.create().into(self).bubble('onchange', self);
              },
              show:function() {
                Html._proto.show.call(self);
                self.input.setFocus();
                return self;
              },
              setValue:function(value) {
                self.input.setValue(value);
              },
              getValue:function() {
                return self.input.getValue();
              }
            }
          })
        }
      },
      SpanBetween:{
        create:function(container) {
          return CritRecForm.CritValueEntry.Spans.SpanSingle.create(container).extend(function(self) {
            return {
              onchange:function() {},
              //
              init:function() {
                self.input.setSize(5);
                self.label = Html.Label.create('p5', 'and').into(self);
                self.input2 = Html.InputText.create(null).setSize(5).into(self).bubble('onchange', self);
              },
              setValue:function(value) {
                var a = value.split(',');
                self.input.setValue(a[0]);
                self.input2.setValue((a.length > 0) ? a[1] : null);
              },
              getValue:function(value) {
                var a = [self.input.getValue(), self.input2.getValue()];
                return a.join(',');
              }
            }
          })
        }
      },
      SpanSelect:{
        create:function(container) {
          return Html.Span.create().into(container).extend(function(self) {
            return {
              onchange:function() {},
              //
              load:function(cv) {
                self.cv = cv;
                self.select = Html.Select.create(cv.getFixedValues()).into(self).bubble('onchange', self.select_onchange);
                self._saveText();
                return self;
              },
              show:function() {
                Html._proto.show.call(self);
                self.select.setFocus();
                return self;
              },
              setValue:function(value) {
                self.select.setValue(value);
                self._saveText();
              },
              getValue:function() {
                return self.select.getValue();
              },
              //
              _saveText:function() {
                self.cv.text_ = self.select.getText();
              },
              select_onchange:function() {
                self._saveText();
                self.onchange();
              }
            }
          })
        }
      },
      SpanPicker:{
        create:function(container) {
          return Html.Span.create().into(container).extend(function(self) {
            return {
              onchange:function() {},
              //
              load:function(cv) {
                self.cv = cv;
                self.picker = cv.getPicker().create().into(self);
                return self;
              },
              show:function() {
                Html._proto.show.call(self);
                self.picker.setFocus();
                return self;
              },
              setValue:function(value) {
                self.picker.setValue(value);
              },
              getValue:function() {
                return self.picker.getValue();
              }
            }
          })
        }
      },
      SpanRecPicker:{
        create:function(container) {
          return CritRecForm.CritValueEntry.Spans.SpanPicker.create(container).extend(function(self) {
            return {
              onchange:function() {},
              //
              load:function(cv) {
                self.cv = cv;
                self.picker = cv.getRecPicker().create().into(self).bubble('onset', self);
                if (self.picker.load) 
                  self.picker.load();
                return self;
              },
              setValue:function(value) {
                if (self.cv._rec)
                  self.picker.set(self.cv._rec);
                else
                  self.picker.setValueText(self.cv.value, self.cv.text_);
              },
              getValue:function() {
                return self.picker.getValue();
              },
              onset:function(rec) {
                self.cv.text_ = self.picker.getText();
                self.cv._rec = rec;
              }
            }
          })
        }
      }
    }
  }
}
/**
 * Pop GenRemindersPop
 */
GenRemindersPop = {
  /*
   * @arg Client_Rep recs 
   */
  pop:function(recs) {
    return this.create().pop(recs);
  },
  create:function() {
    return GenRemindersPop = Html.Pop.create('Generate Reminders').extend(function(self) {
      return {
        init:function() {
          self.input = Html.TextArea.create().setWidth(500).setRows(10).into(self.content);
          self.cb = Html.CmdBar.create(self.content).button('Send Now', self.send_onclick, 'send').cancel(self.close);
        },
        onshow:function(recs) {
        }
      }
    })
  }
}
